# 災害復旧・バックアップ設計（DR/Backup）

## 概要

Review Predictorの災害復旧（Disaster Recovery）、バックアップ、および可用性に関する設計ドキュメントです。

---

## RPO/RTO 定義

### RPO（Recovery Point Objective）

**目標復旧時点 = 24時間**

| 項目 | 説明 |
|------|------|
| 定義 | データ損失を許容できる最大時間 |
| 設定値 | **24時間** |
| 理由 | シミュレーション結果は再実行可能なため、1日分のデータ損失は許容範囲 |

### RTO（Recovery Time Objective）

**目標復旧時間 = 4時間**

| 項目 | 説明 |
|------|------|
| 定義 | システム停止を許容できる最大時間 |
| 設定値 | **4時間** |
| 理由 | 業務クリティカルではないため、半日以内の復旧で十分 |

---

## バックアップ戦略

### データベースバックアップ

```
┌─────────────────────────────────────────────────────────────┐
│                    バックアップ構成                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   PostgreSQL (本番)                                         │
│        │                                                    │
│        ├──→ [日次] pg_dump → バックアップファイル (.sql)    │
│        │           └──→ 7日間保持                           │
│        │                                                    │
│        └──→ [週次] フルバックアップ                         │
│                    └──→ 4週間保持                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### バックアップスケジュール

| 種類 | 頻度 | 保持期間 | 方法 |
|------|------|----------|------|
| 日次バックアップ | 毎日 03:00 | 7日間 | pg_dump |
| 週次フルバックアップ | 毎週日曜 03:00 | 4週間 | pg_dump --format=custom |
| 月次アーカイブ | 毎月1日 | 1年間 | 外部ストレージ |

### バックアップコマンド例

```bash
# 日次バックアップ
pg_dump -h localhost -U postgres -d review_predictor \
  -F c -f backup_$(date +%Y%m%d).dump

# リストア
pg_restore -h localhost -U postgres -d review_predictor \
  -c backup_20250101.dump
```

---

## 災害復旧計画（DRP）

### 想定シナリオ

| シナリオ | 影響度 | 発生確率 | 対策 |
|----------|--------|----------|------|
| DBサーバー障害 | 高 | 低 | バックアップからリストア |
| データ破損 | 中 | 低 | 日次バックアップから復旧 |
| 誤操作によるデータ削除 | 中 | 中 | CASCADE DELETE + 確認UI |
| ネットワーク障害 | 低 | 中 | ローカル環境で継続 |

### 復旧手順

#### シナリオ1: データベース障害

```
1. 障害検知
   └─→ ヘルスチェック API (/api/health) の失敗

2. 状況確認
   └─→ PostgreSQL の状態確認
   └─→ ログの確認

3. 復旧判断
   ├─→ 軽微な障害 → PostgreSQL 再起動
   └─→ 重大な障害 → バックアップからリストア

4. バックアップリストア
   └─→ 最新の日次バックアップを適用
   └─→ docker-compose down && docker-compose up -d

5. 動作確認
   └─→ /api/health で接続確認
   └─→ サンプルシミュレーション実行

6. 報告
   └─→ 障害報告書の作成
```

#### シナリオ2: 誤操作によるデータ削除

```
1. 影響範囲の特定
   └─→ 削除されたデータの確認

2. 復旧方法の選択
   ├─→ 個別データ → 再シミュレーション実行
   └─→ 大量データ → バックアップからリストア

3. リストア実行
   └─→ pg_restore で復旧

4. データ整合性確認
   └─→ レコード数の確認
   └─→ 外部キー制約の確認
```

---

## 可用性設計

### 現在の構成（開発環境）

```
┌─────────────────────────────────────────┐
│            Single Instance              │
│                                         │
│   ┌─────────────┐    ┌─────────────┐   │
│   │  Next.js    │───→│ PostgreSQL  │   │
│   │  (App)      │    │  (Docker)   │   │
│   └─────────────┘    └─────────────┘   │
│                                         │
│   可用性: 99% (単一障害点あり)          │
└─────────────────────────────────────────┘
```

### 本番環境向け構成（推奨）

```
┌─────────────────────────────────────────────────────────┐
│                  High Availability                       │
│                                                         │
│   ┌─────────────┐         ┌─────────────────────────┐  │
│   │ Load        │         │ PostgreSQL Cluster      │  │
│   │ Balancer    │         │                         │  │
│   └──────┬──────┘         │ ┌─────────┐ ┌─────────┐│  │
│          │                │ │ Primary │→│ Replica ││  │
│   ┌──────┴──────┐         │ └─────────┘ └─────────┘│  │
│   │             │         └─────────────────────────┘  │
│   ▼             ▼                     │                │
│ ┌─────┐     ┌─────┐                   │                │
│ │App 1│     │App 2│───────────────────┘                │
│ └─────┘     └─────┘                                    │
│                                                         │
│   可用性: 99.9%                                         │
└─────────────────────────────────────────────────────────┘
```

### 可用性目標

| 環境 | 可用性 | 年間ダウンタイム |
|------|--------|------------------|
| 開発環境 | 99% | 約87時間 |
| 本番環境（目標） | 99.9% | 約8.7時間 |

---

## 監視・アラート

### ヘルスチェック

```typescript
// GET /api/health
export async function GET() {
  try {
    // DB接続確認
    await prisma.$queryRaw`SELECT 1`;
    return NextResponse.json({ status: 'healthy' });
  } catch (error) {
    return NextResponse.json(
      { status: 'unhealthy', error: error.message },
      { status: 503 }
    );
  }
}
```

### 監視項目

| 項目 | 閾値 | アラート |
|------|------|----------|
| DB接続 | 失敗 | 即時通知 |
| API応答時間 | > 10秒 | 警告 |
| ディスク使用率 | > 80% | 警告 |
| メモリ使用率 | > 90% | 警告 |

---

## データ整合性

### 外部キー制約によるデータ保護

```sql
-- シミュレーション削除時、関連する予測レビューも自動削除
ALTER TABLE predicted_reviews
ADD CONSTRAINT fk_simulation
FOREIGN KEY (simulationId)
REFERENCES simulations(id)
ON DELETE CASCADE;
```

### トランザクションによる原子性保証

```typescript
// 商品とシミュレーションを同時に作成
await prisma.$transaction(async (tx) => {
  await tx.product.create({...});
  await tx.simulation.create({...});
  // どちらかが失敗したら両方ロールバック
});
```

---

## 関連ドキュメント

- [システムアーキテクチャ](SYSTEM_ARCHITECTURE.md)
- [パフォーマンスチューニング](PERFORMANCE.md)
- [トランザクション設計](TRANSACTION.md)
