// Review Predictor - Prisma Schema
// 10,000人の仮想顧客プロファイルによるレビュー予測システム
//
// データベース課題として評価されるポイント：
// 1. リレーショナル設計（外部キー、CASCADE）
// 2. 正規化（第3正規形準拠）
// 3. インデックス最適化
// 4. ベクトル検索（pgvector）

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ========================================
// 販売者
// ========================================
model Seller {
  id        String    @id @default(cuid())
  name      String
  email     String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("sellers")
}

// ========================================
// カテゴリ
// ========================================
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  products    Product[]

  @@map("categories")
}

// ========================================
// 商品
// ========================================
model Product {
  id          String                     @id @default(cuid())
  sellerId    String
  seller      Seller                     @relation(fields: [sellerId], references: [id])
  categoryId  String
  category    Category                   @relation(fields: [categoryId], references: [id])
  name        String
  description String                     @db.Text
  embedding   Unsupported("vector(384)")
  price       Decimal                    @db.Decimal(10, 2)
  simulations Simulation[]
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt

  @@index([sellerId])
  @@index([categoryId])
  @@map("products")
}

// ========================================
// 顧客セグメント（4種類）
// ========================================
model Segment {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  customers   Customer[]

  @@map("segments")
}

// ========================================
// 顧客（10,000人）
// ========================================
model Customer {
  id               String                     @id @default(cuid())
  segmentId        String
  segment          Segment                    @relation(fields: [segmentId], references: [id])
  name             String
  profileVector    Unsupported("vector(5)")   // [価格敏感度, 品質重視度, デザイン重視度, ブランドロイヤリティ, レビュー厳しさ]
  preferenceVector Unsupported("vector(384)") // テキスト埋め込みベクトル
  predictedReviews PredictedReview[]
  createdAt        DateTime                   @default(now())

  @@index([segmentId])
  @@map("customers")
}

// ========================================
// シミュレーション
// ========================================
model Simulation {
  id               String            @id @default(cuid())
  productId        String
  product          Product           @relation(fields: [productId], references: [id])
  status           SimulationStatus  @default(PENDING)
  avgRating        Decimal?          @db.Decimal(3, 2)
  conversionRate   Decimal?          @db.Decimal(5, 2)
  predictedReviews PredictedReview[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([productId])
  @@map("simulations")
}

enum SimulationStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// ========================================
// 予測レビュー
// ========================================
model PredictedReview {
  id           String     @id @default(cuid())
  simulationId String
  simulation   Simulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)
  customerId   String
  customer     Customer   @relation(fields: [customerId], references: [id])
  rating       Int        // 1-5の星評価
  similarity   Decimal    @db.Decimal(5, 4) // 類似度スコア
  reviewText   String?    @db.Text // 生成されたレビューテキスト
  createdAt    DateTime   @default(now())

  @@unique([simulationId, customerId])
  @@index([simulationId])
  @@map("predicted_reviews")
}
