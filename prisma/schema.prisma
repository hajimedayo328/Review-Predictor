// Market Mirror - Prisma Schema (DESIGN_DOCUMENT.md準拠)
// PDCAサイクル自動実行Webアプリ
// データベース課題として評価されるポイント：
// 1. リレーショナル設計（外部キー、CASCADE）
// 2. 正規化（第3正規形準拠）
// 3. インデックス最適化
// 4. 一意制約

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ペルソナマスターデータ（90人固定）
// ========================================
model Persona {
  id          String   @id @default(cuid())
  name        String   // 例: 佐藤太郎
  category    Category
  age         Int
  occupation  String   // 例: 会社員（営業）
  background  String   @db.Text // 詳細プロフィール

  feedbacks   Feedback[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@map("personas")
}

// ========================================
// 3つのカテゴリ定義
// ========================================
enum Category {
  JAPAN_STANDARD    // 日本標準（一般的な日本人30人）
  BUSINESS_FOCUSED  // ビジネス特化（経営者・投資家30人）
  TECH_ADVANCED     // テクノロジー先進（エンジニア・研究者30人）
}

// ========================================
// ビジネスアイデア
// ========================================
model Idea {
  id          String     @id @default(cuid())
  content     String     @db.Text  // Plan: アイデア本文
  category    Category              // 選択されたカテゴリ
  cycleCount  Int                   // PDCA実行回数（1/3/5/10）
  status      IdeaStatus @default(PENDING)

  cycles      PDCACycle[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ideas")
}

enum IdeaStatus {
  PENDING    // 未実行
  RUNNING    // 実行中
  COMPLETED  // 完了
  FAILED     // 失敗
}

// ========================================
// PDCAサイクル（1回目、2回目...）
// ========================================
model PDCACycle {
  id          String   @id @default(cuid())
  ideaId      String
  idea        Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)

  cycleNumber Int      // 何回目（1, 2, 3, ...）

  feedbacks   Feedback[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([ideaId, cycleNumber])
  @@index([ideaId])
  @@map("pdca_cycles")
}

// ========================================
// 各ペルソナのフィードバック（D, C, A）
// ========================================
model Feedback {
  id          String    @id @default(cuid())
  cycleId     String
  cycle       PDCACycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  personaId   String
  persona     Persona   @relation(fields: [personaId], references: [id])

  doResponse    String  @db.Text  // D: 実際に試すなら何をする？
  checkResponse String  @db.Text  // C: Doに対するフィードバック
  actResponse   String  @db.Text  // A: 改善案の提案

  createdAt   DateTime @default(now())

  @@unique([cycleId, personaId])
  @@index([cycleId])
  @@map("feedbacks")
}
