"use strict";(()=>{var e={};e.id=284,e.ids=[284],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9105:e=>{e.exports=import("@xenova/transformers")},7655:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{originalPathname:()=>p,patchFetch:()=>u,requestAsyncStorage:()=>m,routeModule:()=>c,serverHooks:()=>d,staticGenerationAsyncStorage:()=>g});var n=a(9303),i=a(8716),o=a(670),s=a(7232),l=e([s]);s=(l.then?(await l)():l)[0];let c=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/simulate/route",pathname:"/api/simulate",filename:"route",bundlePath:"app/api/simulate/route"},resolvedPagePath:"C:\\Users\\赤塩甫\\OneDrive\\ドキュメント\\授業\\データベース\\finalapp\\src\\app\\api\\simulate\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:d}=c,p="/api/simulate/route";function u(){return(0,o.patchFetch)({serverHooks:d,staticGenerationAsyncStorage:g})}r()}catch(e){r(e)}})},7232:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{POST:()=>g,maxDuration:()=>d});var n=a(7070),i=a(728),o=a(8010),s=a(2575),l=a(3995),u=a(940),c=a(4090),m=e([o]);o=(m.then?(await m)():m)[0];let d=300;async function g(e){try{let{description:t,productName:a,price:r,categoryId:m}=await e.json();if(!t||"string"!=typeof t)return n.NextResponse.json({error:"description is required"},{status:400});if(t.length<10)return n.NextResponse.json({error:"description must be at least 10 characters"},{status:400});console.log("\uD83D\uDE80 Starting simulation..."),console.log(`   Description: ${t.substring(0,50)}...`),console.log("\uD83D\uDCCA Step 1: Generating embedding...");let g=await (0,o.v2)(t);console.log(`   Embedding dimension: ${g.length}`),console.log("\uD83D\uDCBE Step 2: Creating database records...");let d=await i._.$transaction(async e=>{let n=await e.seller.findFirst(),i=m?await e.category.findUnique({where:{id:m}}):await e.category.findFirst();if(!n||!i)throw Error("Default seller or category not found. Please run seed first.");let s=`prod_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;await e.$executeRawUnsafe(`
        INSERT INTO products (id, "sellerId", "categoryId", name, description, embedding, price, "createdAt", "updatedAt")
        VALUES (
          '${s}',
          '${n.id}',
          '${i.id}',
          '${(a||"シミュレーション商品").replace(/'/g,"''")}',
          '${t.replace(/'/g,"''")}',
          '${(0,o.RE)(g)}'::vector(384),
          ${r||1e3},
          NOW(),
          NOW()
        )
      `);let l=await e.simulation.create({data:{productId:s,status:"RUNNING"}});return{productId:s,simulationId:l.id}});console.log(`   Product ID: ${d.productId}`),console.log(`   Simulation ID: ${d.simulationId}`),console.log("\uD83D\uDD0D Step 3: Searching similar customers...");let p=await (0,s.bk)(g,1e4);console.log(`   Found ${p.length} customers`),console.log("⭐ Step 4: Predicting ratings...");let h=(0,l.MS)(p);console.log("\uD83D\uDCC8 Step 5: Aggregating results...");let f=h.map((e,t)=>({...e,segmentName:p[t].segmentName})),I=(0,u.h)(f);console.log("\uD83D\uDCDD Step 6: Generating review texts...");let D=h.map((e,t)=>{let a=p[t];return(0,c.L)({rating:e.rating,segmentName:a.segmentName,similarity:e.similarity,profileVector:a.profileVector})});console.log("\uD83D\uDCBE Step 7: Saving predicted reviews...");for(let e=0;e<h.length;e+=1e3){let t=h.slice(e,e+1e3).map((t,a)=>{let r=p[e+a],n=D[e+a].replace(/'/g,"''");return`('pr_${Date.now()}_${e+a}', '${d.simulationId}', '${r.customerId}', ${t.rating}, ${t.similarity.toFixed(4)}, '${n}', NOW())`}).join(",");await i._.$executeRawUnsafe(`
        INSERT INTO predicted_reviews (id, "simulationId", "customerId", rating, similarity, "reviewText", "createdAt")
        VALUES ${t}
      `)}return console.log("✅ Step 8: Finalizing simulation..."),await i._.simulation.update({where:{id:d.simulationId},data:{status:"COMPLETED",avgRating:I.avgRating,conversionRate:I.conversionRate}}),console.log("\uD83C\uDF89 Simulation completed!"),console.log(`   Average Rating: ${I.avgRating}`),console.log(`   Conversion Rate: ${I.conversionRate}%`),n.NextResponse.json({success:!0,simulationId:d.simulationId,summary:{totalCustomers:I.totalCustomers,avgRating:I.avgRating,conversionRate:I.conversionRate}})}catch(e){return console.error("❌ Simulation error:",e),n.NextResponse.json({error:"Simulation failed",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}r()}catch(e){r(e)}})},940:(e,t,a)=>{a.d(t,{h:()=>n});var r=a(3995);function n(e){let t=e.length;if(0===t)return{totalCustomers:0,avgRating:0,conversionRate:0,distribution:{star1:0,star2:0,star3:0,star4:0,star5:0},segments:[]};let a=e.reduce((e,t)=>e+t.rating,0),n=e.filter(e=>e.rating>=4).length,i=(0,r.ey)(e),o=new Map;for(let t of e){let e=o.get(t.segmentName)||[];e.push(t),o.set(t.segmentName,e)}let s=[];for(let[e,t]of o){let a=t.reduce((e,t)=>e+t.rating,0)/t.length,n=(0,r.ey)(t);s.push({segmentName:e,customerCount:t.length,avgRating:Math.round(100*a)/100,distribution:n})}return s.sort((e,t)=>e.segmentName.localeCompare(t.segmentName)),{totalCustomers:t,avgRating:Math.round(a/t*100)/100,conversionRate:Math.round(n/t*1e4)/100,distribution:i,segments:s}}},3995:(e,t,a)=>{a.d(t,{MS:()=>n,ey:()=>i});let r={PRICE_SENSITIVITY:0,QUALITY_FOCUS:1,DESIGN_FOCUS:2,BRAND_LOYALTY:3,REVIEW_STRICTNESS:4};function n(e){if(0===e.length)return[];let t=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;for(let r of e)r.similarity<t&&(t=r.similarity),r.similarity>a&&(a=r.similarity);let n=a-t||1;return e.map(e=>{let a=(e.similarity-t)/n;return{customerId:e.customerId,rating:function(e,t){let a=t[r.PRICE_SENSITIVITY]||.5,n=t[r.QUALITY_FOCUS]||.5,i=t[r.DESIGN_FOCUS]||.5,o=t[r.BRAND_LOYALTY]||.5,s=t[r.REVIEW_STRICTNESS]||.5,l=5*e;return e>.7&&n>.7&&(l=Math.min(5,l+.8)),e>.6&&o>.7&&(l=Math.min(5,l+.5)),e>.4&&e<.7&&a>.7&&(l=Math.max(2,l-.5)),e<.3&&(l=Math.min(2.5,l)),s>.7?l=Math.max(1,l-.5):s<.3&&(l=Math.min(5,l+.3)),i>.7&&e>.4&&e<.7&&(l=Math.min(5,Math.max(3,l))),Math.max(1,Math.min(5,Math.round(l)))}(a,e.profileVector),similarity:e.similarity}})}function i(e){let t={star1:0,star2:0,star3:0,star4:0,star5:0},a=e.length;for(let{rating:a}of e)switch(a){case 1:t.star1++;break;case 2:t.star2++;break;case 3:t.star3++;break;case 4:t.star4++;break;case 5:t.star5++}return{star1:a>0?t.star1/a*100:0,star2:a>0?t.star2/a*100:0,star3:a>0?t.star3/a*100:0,star4:a>0?t.star4/a*100:0,star5:a>0?t.star5/a*100:0}}},4090:(e,t,a)=>{a.d(t,{L:()=>i});let r={star5:["期待以上の品質でした！","とても満足しています。","この価格でこの品質は素晴らしいです。","長く使えそうで安心です。","デザインも機能も完璧です。","購入して正解でした。","友人にもおすすめしたいです。"],star4:["良い商品だと思います。","期待通りでした。","コスパは良いと思います。","満足しています。","悪くはないですが、もう少し改善の余地があるかもしれません。","基本的には良い商品です。","値段相応の品質だと思います。"],star3:["普通だと思います。","まあまあです。","期待していたほどではありませんでした。","良い点も悪い点もあります。","特に問題はありませんが、特別良いとも言えません。","平均的な品質だと思います。","もう少し改善してほしい点があります。"],star2:["期待外れでした。","あまり満足できませんでした。","品質に不安があります。","もう少し安ければ良いのですが。","改善の余地が大きいです。","期待していたものと違いました。","コスパが悪いと思います。"],star1:["期待していたものと大きく違いました。","品質に問題があると思います。","購入を後悔しています。","おすすめできません。","改善が必要です。","期待外れでした。","この価格では納得できません。"]},n={ブランド重視:{5:["信頼できるブランドなので安心です。","ブランドの品質が感じられます。"],4:["ブランドとして期待通りです。","ブランド価値はあると思います。"],3:["ブランドとしては普通です。","ブランド名に期待していたほどではありません。"],2:["ブランドにしては物足りないです。","ブランド価値が感じられません。"],1:["ブランドとして期待外れでした。","ブランド名に値しない品質です。"]},デザイン重視:{5:["デザインが素晴らしいです！","見た目がとても気に入りました。"],4:["デザインは良いと思います。","見た目は悪くないです。"],3:["デザインは普通です。","デザインに特別な魅力は感じません。"],2:["デザインが物足りないです。","もう少しデザインに工夫が欲しいです。"],1:["デザインが期待外れでした。","デザインが気に入りません。"]},価格重視:{5:["この価格でこの品質は最高です！","コスパが抜群です。"],4:["価格相応の品質だと思います。","コスパは良いと思います。"],3:["価格と品質のバランスは普通です。","もう少し安ければ良いのですが。"],2:["価格の割に品質が物足りないです。","コスパが悪いと思います。"],1:["この価格では納得できません。","価格に対して品質が低すぎます。"]},品質重視:{5:["品質が非常に高いです！","長く使えそうで安心です。"],4:["品質は良いと思います。","品質に問題はありません。"],3:["品質は普通です。","品質に不安があります。"],2:["品質が期待外れでした。","品質に問題があると思います。"],1:["品質に大きな問題があります。","品質が低すぎます。"]}};function i(e){let{rating:t,segmentName:a,similarity:i,profileVector:o}=e,s=r[`star${t}`]||r.star3,l=s[Math.floor(Math.random()*s.length)],u=n[a]?.[t]||[],c=u.length>0?u[Math.floor(Math.random()*u.length)]:"",m="";i>.7?m="商品の特徴が自分の好みに合っています。":i<.3&&(m="商品の特徴が自分の好みと少し違いました。");let g=o[0]||.5,d=o[1]||.5,p="";t>=4?d>.7?p="品質が期待通りでした。":g>.7&&(p="価格に対して満足しています。"):t<=2&&(d>.7?p="品質に不満があります。":g>.7&&(p="価格に対して不満があります。"));let h=[l];return c&&h.push(c),m&&h.push(m),p&&h.push(p),h.join(" ")}},8010:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{RE:()=>l,v2:()=>s});var n=a(9105),i=e([n]);n=(i.then?(await i)():i)[0];let u=null;async function o(){return u||(console.log("\uD83D\uDD04 Loading embedding model (first time may take a while)..."),u=await (0,n.pipeline)("feature-extraction","Xenova/all-MiniLM-L6-v2"),console.log("✅ Embedding model loaded")),u}async function s(e){let t=await o(),a=await t(e,{pooling:"mean",normalize:!0});return Array.from(a.data)}function l(e){return`[${e.join(",")}]`}r()}catch(e){r(e)}})},2575:(e,t,a)=>{a.d(t,{bk:()=>n});var r=a(728);async function n(e,t=1e4){let a=`[${e.join(",")}]`;return(await r._.$queryRaw`
    SELECT
      c.id as "customerId",
      c.name as "customerName",
      c."segmentId",
      s.name as "segmentName",
      (1 - (c."preferenceVector" <=> ${a}::vector(384))) as similarity,
      c."profileVector"::text as "profileVectorStr"
    FROM customers c
    JOIN segments s ON c."segmentId" = s.id
    ORDER BY c."preferenceVector" <=> ${a}::vector(384)
    LIMIT ${t}
  `).map(e=>{var t;return{...e,profileVector:(t=e.profileVectorStr)?t.replace(/^\[|\]$/g,"").split(",").map(e=>parseFloat(e.trim())):[]}})}},728:(e,t,a)=>{a.d(t,{_:()=>n});let r=require("@prisma/client"),n=global.prisma||new r.PrismaClient({log:["query","error","warn"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,972],()=>a(7655));module.exports=r})();